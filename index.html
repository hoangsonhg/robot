<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot CND - Ch·ªçn Gi·ªçng N√≥i</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a2e; color: white; padding: 20px; }
        .robot-card { background: #16213e; border-radius: 20px; padding: 25px; max-width: 450px; margin: auto; border: 1px solid #0f3460; }
        select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; }
        #micBtn { background: #e94560; color: white; font-size: 20px; cursor: pointer; height: 60px; }
        #micBtn.active { background: #00d2ff; }
        #chatbox { margin-top: 20px; background: rgba(0,0,0,0.3); height: 150px; overflow-y: auto; padding: 10px; text-align: left; font-size: 14px; border-radius: 10px; }
        label { display: block; text-align: left; margin-top: 10px; color: #00d2ff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="robot-card">
        <h3>ü§ñ L·ªÖ T√¢n CND ƒê·ªìng VƒÉn</h3>
        
        <label>1. Ch·ªçn gi·ªçng ƒë·ªçc (∆Øu ti√™n vi-VN):</label>
        <select id="voiceSelect"></select>

        <label>2. Ch·ªânh ƒë·ªô nh√≠ nh·∫£nh (Pitch):</label>
        <input type="range" id="pitch" min="0.5" max="2" value="1.4" step="0.1" style="width:100%">

        <button id="micBtn">üéôÔ∏è Ch·∫°m ƒë·ªÉ n√≥i chuy·ªán</button>
        <div id="status" style="color:#00d2ff; margin:10px 0;">S·∫µn s√†ng!</div>
        <div id="chatbox"></div>
    </div>

    <script>
        const API_KEY = "AIzaSyCs8gITrFcSUHYe_6KeJnWrcQd0tBdMgwo";
        const MODEL = "gemini-3-flash-preview"; 
        const MENU_CND = "L·∫©u Ng·ª±a 600k-1.2tr, M·∫πt ƒë·∫∑c s·∫£n 1tr, G√† ƒëen 250k, R∆∞·ª£u ng√¥ 40k.";

        const voiceSelect = document.getElementById('voiceSelect');
        const pitchInput = document.getElementById('pitch');
        const micBtn = document.getElementById('micBtn');
        const chatbox = document.getElementById('chatbox');
        const status = document.getElementById('status');

        let voices = [];

        // 1. L·∫§Y DANH S√ÅCH GI·ªåNG N√ìI T·ª™ ƒêI·ªÜN THO·∫†I
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            voiceSelect.innerHTML = voices
                .map((voice, i) => `<option value="${i}">${voice.name} (${voice.lang})</option>`)
                .join('');
            
            // T·ª± ƒë·ªông ch·ªçn gi·ªçng ti·∫øng Vi·ªát n·∫øu c√≥
            const viIndex = voices.findIndex(v => v.lang.includes('vi'));
            if (viIndex !== -1) voiceSelect.value = viIndex;
        }

        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        // 2. SETUP NGHE & N√ìI
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recog = new SpeechRecognition();
        recog.lang = 'vi-VN';

        const speak = (text) => {
            window.speechSynthesis.cancel(); // T·∫Øt c√¢u ƒëang n√≥i d·ªü
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = voices[voiceSelect.value];
            utterance.pitch = pitchInput.value; // ƒê·ªô cao (nh√≠ nh·∫£nh)
            utterance.rate = 1.0; // T·ªëc ƒë·ªô ƒë·ªçc
            window.speechSynthesis.speak(utterance);
        };

        micBtn.onclick = () => {
            recog.start();
            micBtn.classList.add('active');
            status.innerText = "Em ƒëang nghe ƒë√¢y anh S∆°n...";
        };

        recog.onresult = async (event) => {
            micBtn.classList.remove('active');
            const userText = event.results[0][0].transcript;
            addMsg("Anh S∆°n", userText);
            status.innerText = "ƒêang h·ªèi Gemini 3.0...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `B·∫°n l√† l·ªÖ t√¢n CND ƒê·ªìng VƒÉn, 18 tu·ªïi. Ch·ªâ b√°o gi√° theo menu: ${MENU_CND}. Tr·∫£ l·ªùi d∆∞·ªõi 15 t·ª´, d·∫° ·∫°.` }, { text: userText }] }]
                    })
                });
                const data = await response.json();
                const aiReply = data.candidates[0].content.parts[0].text;
                addMsg("Robot", aiReply);
                speak(aiReply);
                status.innerText = "B·∫•m ƒë·ªÉ n√≥i ti·∫øp!";
            } catch (err) {
                status.innerText = "L·ªói k·∫øt n·ªëi r·ªìi ·∫°!";
            }
        };

        function addMsg(s, m) {
            chatbox.innerHTML += `<div><b>${s}:</b> ${m}</div>`;
            chatbox.scrollTop = chatbox.scrollHeight;
        }
    </script>
</body>
</html>
