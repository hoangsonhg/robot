<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot CND - Streaming</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #000; color: #0f0; padding: 20px; }
        #status { font-size: 24px; color: #fff; margin: 20px; }
        #reply { color: #58a6ff; font-size: 20px; font-weight: bold; margin-top: 20px; min-height: 50px; }
    </style>
</head>
<body>
    <h2>⚡ LỄ TÂN CND (BẢN STREAMING)</h2>
    <div id="status">Đang chờ anh kích hoạt...</div>
    <button id="startBtn" style="padding: 20px; background: #238636; color: white; border: none; border-radius: 10px; font-weight: bold;">KÍCH HOẠT</button>
    <div id="reply"></div>

    <script>
        const API_KEY = "AIzaSyCs8gITrFcSUHYe_6KeJnWrcQd0tBdMgwo";
        const MODEL = "gemini-3.0-flash"; // Model 2026 siêu tốc
        const SYSTEM = "Bạn là lễ tân nhà hàng CND. Trả lời cực ngắn, lễ phép. Thực đơn: Lẩu ngựa 600k, Mẹt 1tr. Chủ là anh Sơn.";

        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const replyDiv = document.getElementById('reply');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recog = new SpeechRecognition();
        recog.lang = 'vi-VN';

        startBtn.onclick = () => { recog.start(); startBtn.style.display = 'none'; };

        recog.onresult = async (event) => {
            const query = event.results[0][0].transcript;
            status.innerText = "Đang hỏi AI...";
            replyDiv.innerText = "";

            // KỸ THUẬT STREAMING TRÊN WEB
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:streamGenerateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: SYSTEM + " Câu hỏi: " + query }] }] })
                });

                const reader = response.body.getReader();
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = new TextDecoder().decode(value);
                    // Bóc tách text từ chunk JSON của Google
                    const match = chunk.match(/"text":\s*"(.*?)"/);
                    if (match) {
                        const word = match[1];
                        replyDiv.innerText += word;
                        fullText += word;
                    }
                }
                
                // Nói sau khi đã nhận được các mảnh dữ liệu đầu tiên
                const msg = new SpeechSynthesisUtterance(fullText);
                msg.lang = 'vi-VN';
                msg.onend = () => recog.start();
                window.speechSynthesis.speak(msg);
                status.innerText = "Xong rồi ạ!";

            } catch (e) {
                status.innerText = "Lỗi rồi!";
                recog.start();
            }
        };
    </script>
</body>
</html>
