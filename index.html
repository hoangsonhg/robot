<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot CND - Ch·∫ø ƒë·ªô r·∫£nh tay</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #0f172a; color: white; padding: 20px; }
        .status-circle { width: 150px; height: 150px; border-radius: 50%; background: #1e293b; margin: 30px auto; display: flex; align-items: center; justify-content: center; border: 5px solid #334155; transition: 0.5s; }
        .status-circle.listening { border-color: #22c55e; box-shadow: 0 0 30px #22c55e; }
        .status-circle.speaking { border-color: #3b82f6; box-shadow: 0 0 30px #3b82f6; }
        #startBtn { padding: 15px 30px; border-radius: 50px; border: none; background: #ef4444; color: white; font-weight: bold; cursor: pointer; font-size: 18px; }
        #log { margin-top: 20px; font-size: 14px; color: #94a3b8; height: 100px; overflow-y: auto; text-align: left; padding: 10px; background: rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <h2>ü§ñ L·ªÖ T√¢n CND "Lu√¥n Lu√¥n L·∫Øng Nghe"</h2>
    <div id="visual" class="status-circle">üé§</div>
    <p id="info">B·∫•m n√∫t ƒë·ªÉ k√≠ch ho·∫°t ch·∫ø ƒë·ªô r·∫£nh tay</p>
    <button id="startBtn">K√çCH HO·∫†T ROBOT</button>
    <div id="log"></div>

    <script>
        const API_KEY = "AIzaSyCs8gITrFcSUHYe_6KeJnWrcQd0tBdMgwo";
        const MODEL = "gemini-3-flash-preview";
        const MENU = "L·∫©u Ng·ª±a 600k-1.2tr, M·∫πt ƒë·∫∑c s·∫£n 1tr, G√† ƒëen 250k, R∆∞·ª£u ng√¥ 40k.";

        const startBtn = document.getElementById('startBtn');
        const visual = document.getElementById('visual');
        const info = document.getElementById('info');
        const log = document.getElementById('log');

        // Setup Nghe (Recognition)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recog = new SpeechRecognition();
        recog.lang = 'vi-VN';
        recog.continuous = false; // D√πng false v√† restart ·ªü onend s·∫Ω ·ªïn ƒë·ªãnh h∆°n tr√™n di ƒë·ªông

        // Setup N√≥i (Synthesis)
        const synth = window.speechSynthesis;

        let isRobotActive = false;

        function addLog(text) {
            log.innerHTML = `<div>> ${text}</div>` + log.innerHTML;
        }

        const speak = (text) => {
            visual.className = "status-circle speaking";
            info.innerText = "Em ƒëang tr·∫£ l·ªùi ·∫°...";
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            utterance.pitch = 1.4;

            // KHI N√ìI XONG TH√å T·ª∞ ƒê·ªòNG NGHE L·∫†I
            utterance.onend = () => {
                if (isRobotActive) {
                    recog.start();
                }
            };
            synth.speak(utterance);
        };

        // B·∫ÆT ƒê·∫¶U V√íNG L·∫∂P
        startBtn.onclick = () => {
            isRobotActive = true;
            startBtn.style.display = 'none';
            recog.start();
            addLog("ƒê√£ k√≠ch ho·∫°t ch·∫ø ƒë·ªô t·ª± ƒë·ªông.");
        };

        recog.onstart = () => {
            visual.className = "status-circle listening";
            info.innerText = "Em ƒëang nghe ƒë√¢y anh S∆°n...";
        };

        recog.onresult = async (event) => {
            const userText = event.results[0][0].transcript;
            addLog(`Anh S∆°n: ${userText}`);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `B·∫°n l√† l·ªÖ t√¢n CND ƒê·ªìng VƒÉn. Th·ª±c ƒë∆°n: ${MENU}. Tr·∫£ l·ªùi d∆∞·ªõi 15 t·ª´, d·∫° ·∫°.` }, { text: userText }] }]
                    })
                });
                const data = await response.json();
                const aiReply = data.candidates[0].content.parts[0].text;
                addLog(`Robot: ${aiReply}`);
                speak(aiReply);
            } catch (err) {
                addLog("L·ªói API, ƒëang th·ª≠ nghe l·∫°i...");
                recog.start();
            }
        };

        // N·∫æU KH√îNG NGHE TH·∫§Y G√å HO·∫∂C NG·ª™NG, T·ª∞ ƒê·ªòNG B·∫¨T L·∫†I MIC
        recog.onend = () => {
            if (isRobotActive && !synth.speaking) {
                recog.start();
            }
        };

        recog.onerror = (event) => {
            console.log("L·ªói mic:", event.error);
            if (isRobotActive) setTimeout(() => recog.start(), 1000);
        };
    </script>
</body>
</html>
